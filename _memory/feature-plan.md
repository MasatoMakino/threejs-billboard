# 新規機能実装計画の背景と検討事項

## 1. プロジェクト概要

- 3D空間上に2D描画を行い、ビルボードとして表示するためのライブラリ。
- 2D描画エンジンとして [PixiJS](https://pixijs.com/) を利用。

## 2. 過去の実装と変更経緯

- **旧実装:**
  - 各ビルボードに対して、個別のCanvasとCanvas 2Dコンテキスト (context2d) を生成していた。
  - `1ビルボード = 1 context2d` の独立した描画方式。
- **変更理由:**
  - PixiJSがv7以降、Canvas 2Dコンテキストのサポートを終了し、WebGLレンダリングに一本化。
  - WebGLコンテキストは、1つのJavaScript環境内で生成できるインスタンス数に制限がある。
- **現行実装 (WebGL対応):**
  - インスタンス数制限に対応するため、アーキテクチャを変更。
  - **単一の共有Canvas** と **単一の共有WebGLコンテキスト (PixiJS Application)** をすべてのビルボードで共有。
  - 各ビルボードの描画内容は、共有Canvas上の特定領域に描画される。
  - 共有Canvas全体をテクスチャとして扱い、各ビルボードに対応する3DオブジェクトのUV座標を調整して表示を切り分ける。

## 3. 現行実装の課題

- 不定長のビルボード（多数または大きなビルボード）を扱う場合、共有Canvasが巨大化する。
- 巨大なCanvasでは、一部のビルボード（Canvas上の小さな領域）を更新するだけでも、Canvas全体の再描画とGPUへのテクスチャ転送が必要となる。
- これにより、とくに部分的な更新が多い場合にパフォーマンスが悪化する。

## 4. パフォーマンス改善のための検討アプローチ

現行実装のパフォーマンス課題を解決するため、以下の2つのアプローチを検討中。

### アプローチ1: Context2Dへの回帰 （Konva.js利用）

- **概要:** Canvas 2Dコンテキストをサポートする別のライブラリ [Konva.js](https://github.com/konvajs/konva) を導入し、旧実装に近い「1ビルボード = 1描画コンテキスト」の方式に戻す。
- **メリット:**
  - ビルボードごとの独立した描画領域により、部分更新のコストが低い。
  - Konva.jsは実績のあるライブラリ。
- **デメリット:**
  - PixiJS（WebGL）から離れることになる。
  - 新たなライブラリ依存が増える。

### アプローチ2: 複数Canvas + 単一WebGLコンテキスト (PixiJS v8 multiView利用)

- **概要:** PixiJS v8で導入されたmultiViewオプション ([関連PR](https://github.com/pixijs/pixijs/pull/10913)) を活用する。ビルボードごとに（またはグループごとに）個別のCanvas（TextureSource）を生成し、それらを単一のPixiJSレンダラー（WebGLコンテキスト）で効率的に管理・描画する。
- **メリット:**
  - PixiJSのWebGLレンダリングパイプラインを活用できる。
  - Canvasが小さくなるため、部分更新のコストが低減される可能性がある。
  - PixiJSエコシステム内で完結できる。
- **デメリット:**
  - 利用するPixiJSの機能が比較的新しく、実績や参考情報が少ない。
  - 実装の複雑さやパフォーマンス特性が未知数な部分がある。

## 5. 今後の計画

- **理想:** アプローチ2を採用したい。PixiJSの機能を最大限活用できるため。
- **懸念:** アプローチ2の実現可能性（とくにパフォーマンスと実装の容易さ）が不透明。
- **次の一手:** アプローチ2の実現可能性を検証するための**実験 (Proof of Concept)** を行う。
  - **ステップ1: 基本動作検証**
    - **目的:** PixiJS v8 `multiView` オプションの基本動作、とくにレンダラー直接生成時の挙動を確認する。
    - **方法:** [関連PR](https://github.com/pixijs/pixijs/pull/10913) のコード例を再現する。
    - **評価項目:**
      - 異なるサイズのCanvasを正常にレンダリングできるか？
      - 個別のCanvasのレンダリングタイミングを制御できるか？
  - （ステップ2以降はステップ1の結果を踏まえて計画）
- **代替案:** 実験の結果、アプローチ2が困難と判断された場合は、アプローチ1 (Konva.js) の採用を再検討する。
